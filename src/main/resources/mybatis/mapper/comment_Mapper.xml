<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.ddit.employee.boards.freeBoard.mapper.ICommentMapper">

	<!-- 댓글/대댓글 VO resultMap -->
	<resultMap id="commentMap" type="kr.or.ddit.vo.BoardCMVO">
		<id property="cmNo" column="CM_NO" />
		<result property="boardNo" column="BOARD_NO" />
		<result property="empNo" column="EMP_NO" />
		<result property="cmCn" column="CM_CN" />
		<result property="cmWrtDt" column="CM_WRT_DT" />
		<result property="cmMdfcnDt" column="CM_MDFCN_DT" />
		<result property="delYn" column="DEL_YN" />
		<result property="upperCmNo" column="UPPER_CM_NO" />
		<result property="cmOrdr" column="CM_ORDR" />
		<result property="cmDp" column="CM_DP" />
		<!-- 작성자 이름은 JOIN을 통해 가져올 수 있습니다. -->
		<result property="empNm" column="EMP_NM" />
	</resultMap>

	<!-- 새 댓글 등록 (대댓글이 아닌 일반 댓글) -->
	<insert id="insertComment" parameterType="kr.or.ddit.vo.BoardCMVO">
		<selectKey keyProperty="cmNo" resultType="int" order="BEFORE">
			SELECT SEQ_BOARD_CM.NEXTVAL FROM dual
		</selectKey>
		INSERT INTO board_cm (
			cm_no, board_no, emp_no, cm_cn, cm_wrt_dt, cm_mdfcn_dt,
			del_yn, upper_cm_no, cm_ordr, cm_dp
		) VALUES (
			#{cmNo}, #{boardNo}, #{empNo}, #{cmCn}, SYSDATE, SYSDATE,
			'N', #{cmNo}, #{cmNo}, 0
		)
	</insert>

	<!-- 게시글의 댓글 목록 조회 -->
	<select id="selectCommentList" parameterType="int" resultMap="commentMap">
		SELECT
			c.cm_no, c.board_no, c.emp_no, c.cm_cn, c.cm_wrt_dt, c.cm_mdfcn_dt,
			c.del_yn, c.upper_cm_no, c.cm_ordr, c.cm_dp,
			e.emp_nm
		FROM board_cm c
		LEFT OUTER JOIN emp e ON c.emp_no = e.emp_no
		WHERE c.board_no = #{boardNo}
		AND c.del_yn = 'N'
		ORDER BY c.upper_cm_no ASC, c.cm_ordr ASC
	</select>

	<!-- 대댓글 등록 -->
	<insert id="insertSubComment" parameterType="kr.or.ddit.vo.BoardCMVO">
		<selectKey keyProperty="cmNo" resultType="int" order="BEFORE">
			SELECT SEQ_BOARD_CM.NEXTVAL FROM dual
		</selectKey>
		INSERT INTO board_cm (
			cm_no, board_no, emp_no, cm_cn, cm_wrt_dt, cm_mdfcn_dt,
			del_yn, upper_cm_no, cm_ordr, cm_dp
		) VALUES (
			#{cmNo}, #{boardNo}, #{empNo}, #{cmCn}, SYSDATE, SYSDATE,
			'N',
			(SELECT UPPER_CM_NO FROM BOARD_CM WHERE CM_NO = #{upperCmNo}),
			(SELECT CM_ORDR FROM BOARD_CM WHERE CM_NO = #{upperCmNo}) + 1,
			(SELECT CM_DP FROM BOARD_CM WHERE CM_NO = #{upperCmNo}) + 1
		)
	</insert>
	
	<!-- 대댓글 등록 시 기존 댓글 순서 업데이트 (트랜잭션 필요) -->
    <update id="updateComment" parameterType="kr.or.ddit.vo.BoardCMVO">
        UPDATE board_cm 
        SET cm_ordr = cm_ordr + 1 
        WHERE 
            board_no = #{boardNo} AND upper_cm_no = (SELECT upper_cm_no FROM board_cm WHERE cm_no = #{upperCmNo}) AND cm_ordr > (SELECT cm_ordr FROM board_cm WHERE cm_no = #{upperCmNo})
    </update>
    
    <!-- 대댓글 수정 -->
	<update id="updateSubComment" parameterType="kr.or.ddit.vo.BoardCMVO">
   UPDATE board_cm
   SET 
        cm_cn = #{cmCn},
        cm_mdfcn_dt = SYSDATE
    WHERE 
        cm_no = #{cmNo}
     AND del_yn = 'N'
</update>


	<!-- 댓글 논리적 삭제 -->
	<update id="deleteComment" parameterType="int">
		UPDATE board_cm
		SET del_yn = 'Y'
		WHERE cm_no = #{cmNo} 
		OR upper_cm_no = #{cmNo}
	</update>

</mapper>
