<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.or.ddit.employee.project.mapper.IProjectFileMapper">

	
<resultMap type="kr.or.ddit.vo.ProjectFileVO" id="projectFileMap">
 
    <id property="prjctFileNo" column="PRJCT_FILE_NO"/>
    <result property="prjctNo" column="PRJCT_NO"/>
    <result property="fileTy" column="FILE_TY"/>
    <result property="fileGroupNo" column="FILE_GROUP_NO"/>
    <result property="fileTitle" column="FILE_TITLE"/>
    <result property="fileCn" column="FILE_CN"/> 
    <result property="fileUploader" column="FILE_UPLOADER"/>
    <result property="empNm" column="EMP_NM"/>
    
    <collection property="fileList" ofType="kr.or.ddit.vo.FilesVO" javaType="java.util.ArrayList">
        <id property="fileNo" column="FILE_NO"/>
        <result property="fileGroupNo" column="FILE_GROUP_NO"/>
        <result property="originalNm" column="ORIGINAL_NM"/>
        <result property="fileUploader" column="FILE_UPLOADER"/>
        <result property="savedNm" column="SAVED_NM"/>
        <result property="filePath" column="FILE_PATH"/>
        <result property="fileSize" column="FILE_SIZE"/>
        <result property="fileFancysize" column="FILE_FANCYSIZE"/>
        <result property="fileMime" column="FILE_MIME"/>
        <result property="fileRegDt" column="FILE_REG_DT"/>
        <result property="delYn" column="DEL_YN"/>
    </collection>
</resultMap>



<resultMap type="kr.or.ddit.vo.ProjectFileVO" id="fileListResultMap">
        <id property="prjctFileNo" column="PRJCT_FILE_NO"/>
        <result property="prjctNo" column="PRJCT_NO"/>
        <result property="fileTy" column="FILE_TY"/>
        <result property="fileGroupNo" column="FILE_GROUP_NO"/>
        <result property="fileTitle" column="FILE_TITLE"/>
        <result property="originalNm" column="ORIGINAL_NM"/>
        <result property="filePath" column="FILE_PATH"/>
        <result property="fileSize" column="FILE_SIZE"/>
        <result property="fileRegDt" column="FILE_REG_DT"/>
        <result property="empNm" column="EMP_NM"/>
    </resultMap>




<!-- 파일 목록 조회  -->
<select id="selectFileSelect" parameterType="map" resultType="kr.or.ddit.vo.ProjectFileVO">
		SELECT
            PRJCT_FILE_NO, PRJCT_NO, FILE_TY, FILE_GROUP_NO, FILE_TITLE
        FROM
            PRJCT_FILE
        WHERE
            PRJCT_NO = #{prjctNo}
        <if test="fileTy != null and !fileTy.equals('')">
            AND FILE_TY = #{fileTy}
        </if>
        ORDER BY PRJCT_FILE_NO DESC

</select>




<select id="selectFileCount" parameterType="kr.or.ddit.vo.PaginationInfoVO" resultType="int">
    SELECT
        COUNT(A.PRJCT_FILE_NO)
    <include refid="joinFileAndEmp"/>
    WHERE
        A.PRJCT_NO = #{data.prjctNo}
        AND A.FILE_TY = #{data.fileTy}
    <include refid="searchFiles"/>
</select>



<select id="selectFileAjaxList" parameterType="kr.or.ddit.vo.PaginationInfoVO" resultMap="fileListResultMap">
    SELECT B.*
    FROM (
        SELECT 
            A.PRJCT_FILE_NO, A.PRJCT_NO, A.FILE_TY, A.FILE_TITLE, A.FILE_CN, A.FILE_EMP_NO,
            (SELECT F.ORIGINAL_NM FROM FILES F WHERE F.FILE_GROUP_NO = A.FILE_GROUP_NO AND F.DEL_YN = 'N') AS ORIGINAL_NM,
            (SELECT F.FILE_REG_DT FROM FILES F WHERE F.FILE_GROUP_NO = A.FILE_GROUP_NO AND F.DEL_YN = 'N') AS FILE_REG_DT,
            B.EMP_NM,
            ROW_NUMBER() OVER (ORDER BY A.PRJCT_FILE_NO DESC) AS RNUM
        <include refid="joinFileAndEmp"/>
        WHERE
            A.PRJCT_NO = #{data.prjctNo}
            AND A.FILE_TY = #{data.fileTy}
        <include refid="searchFiles"/>
    ) B
    <![CDATA[
        WHERE B.RNUM BETWEEN #{startRow} AND #{endRow}
    ]]>
    ORDER BY B.RNUM
</select>



<sql id="searchFiles">
    <if test="searchWord != null and searchWord != ''">
        <choose>
            <when test="searchType == 'fileTitle'">
                AND A.FILE_TITLE LIKE '%' || #{searchWord} || '%'
            </when>
            <when test="searchType == 'empNm'">
                AND B.EMP_NM LIKE '%' || #{searchWord} || '%'
            </when>
            <otherwise>
                AND A.FILE_TITLE LIKE '%' || #{searchWord} || '%'
            </otherwise>
        </choose>
    </if>
</sql>

<sql id="joinFileAndEmp">
    FROM
        PRJCT_FILE A LEFT JOIN EMP B ON (A.FILE_EMP_NO = B.EMP_NO)
</sql>








<!-- 프로젝트 담당자 체크  -->
<select id="checkProjectParticipant" resultType="int">
	select
		count(*)
	from 
		prjct_prtcpnt
	where 
		prjct_no = #{prjctNo}
	and 
		emp_no = #{empNo}

</select>

<!-- insertProjectFile -->
<insert id="insertProjectFile" parameterType="kr.or.ddit.vo.ProjectFileVO">
	<selectKey keyProperty="prjctFileNo" resultType="int" order="BEFORE">
		select seq_prjct_file.nextval from dual
	</selectKey>
	insert into prjct_file ( 
		prjct_file_no, prjct_no, file_ty, file_group_no, file_title, file_cn, file_emp_no
	) values (
		#{prjctFileNo}, #{prjctNo}, #{fileTy}, #{fileGroupNo}, #{fileTitle}, #{fileCn}, #{empNo}
	)
</insert>



<!-- 파일 그룹 번호 -->
<select id="generateFileGroupNo" resultType="int">
	select seq_file_group.nextval from dual
</select>


<!-- insertFile -->
<insert id="insertFiles" parameterType="kr.or.ddit.vo.FilesVO">
	insert into files(
		file_group_no, file_no, original_nm, file_uploader, saved_nm, file_path, 
		file_size, file_fancysize, file_mime, file_reg_dt, del_yn	
	)values (
		#{fileGroupNo}, SEQ_FILE.NEXTVAL, #{originalNm}, #{fileUploader}, #{savedNm}, #{filePath}, #{fileSize}, 
	    #{fileFancysize}, #{fileMime}, SYSDATE, 'N'
	)

</insert>



<select id="selectProjectFileDetail" resultMap="projectFileMap">
    SELECT 
        A.PRJCT_FILE_NO
        , A.PRJCT_NO
        , A.FILE_TY
        , A.FILE_GROUP_NO
        , A.FILE_TITLE
        , A.FILE_CN
        , B.FILE_NO
        , B.ORIGINAL_NM
        , B.FILE_UPLOADER
        , B.SAVED_NM
        , B.FILE_PATH
        , B.FILE_SIZE
        , B.FILE_FANCYSIZE
        , B.FILE_MIME
        , B.FILE_REG_DT
        , B.DEL_YN
        , C.EMP_NM
    FROM 
        PRJCT_FILE A
    LEFT JOIN FILES B 
    	ON B.FILE_GROUP_NO = A.FILE_GROUP_NO 
    	AND B.DEL_YN = 'N'
    LEFT JOIN EMP C 
    	ON B.FILE_UPLOADER = C.EMP_NO
    WHERE 
    	A.PRJCT_FILE_NO = #{prjctFileNo}
    ORDER BY 
    	A.PRJCT_FILE_NO DESC
</select>


<!-- fileTy마다 다른 목록 자료 가져오기  -->

	<select id="selectFileList" resultType="ProjectFileVO">
        select 
            prjct_file_no
            , prjct_no
            , file_ty
            , file_group_no
            , file_title
            , file_cn
            , file_emp_no
            , (select original_nm from files f where pf.file_group_no = f.file_group_no and del_yn = 'N') as original_nm
            , (select emp_nm from emp e where e.emp_no = pf.file_emp_no) as emp_nm
            , (select file_reg_dt from files f where pf.file_group_no = f.file_group_no and del_yn = 'N') as file_reg_dt
        from prjct_file pf
        where prjct_no = #{prjctNo}
        and file_ty = #{fileTy}
	</select>




    <select id="selectFileByNo" parameterType="int" resultType="kr.or.ddit.vo.FilesVO">
        SELECT 
            file_group_no, file_no, original_nm, file_uploader, saved_nm, file_path, 
            file_size, file_fancysize, file_mime, file_reg_dt, del_yn
        FROM
            files
        WHERE
            file_no = #{fileNo}
        AND 
            del_yn = 'N'
    </select>
 
 
 
 <update id="updateProjectFile" parameterType="kr.or.ddit.vo.ProjectFileVO">
        UPDATE prjct_file
        SET
            file_ty = #{fileTy},
            file_title = #{fileTitle},
            file_cn = #{fileCn}
        WHERE
            prjct_file_no = #{prjctFileNo}
    </update>
    
    
    <update id="deleteFileByFileNo" parameterType="int">
        UPDATE files
        SET
            del_yn = 'Y'
        WHERE
            file_no = #{fileNo}
    </update>
 
 	<!-- 프로젝트 자료실 내, filesDetail 확인 시 참여자 목록과 로그인 사용자가 일치하는지 확인하기 위한 쿼리 -->
 	<select id="selectProjectPrtcptn" parameterType="int" resultType="kr.or.ddit.vo.ProjectPerticipantVO">
 		select pp.emp_no
        from prjct_file pf left outer join prjct_prtcpnt pp on(pf.prjct_no = pp.prjct_no)
        where prjct_file_no = #{prjctFileNo}
 	</select>
 
 
 
 	<!-- 프로젝트 자료 물리적 삭제 -->
    <delete id="deleteProjectFile" parameterType="int">
        DELETE FROM PRJCT_FILE
        WHERE
            PRJCT_FILE_NO = #{prjctFileNo}
    </delete>
 
 
 

</mapper>
